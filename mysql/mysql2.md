# 连接查询

[toc]
1. 多张表共同记录，防止浪费空间

2. 分类
   * 内连接
      * 等值连接
      * 非等值连接
      * 子连接 
   * 外连接
     * 左外连接
     * 右连接
   * 全连接

#### 笛卡尔积现象
**学生都上了什么课？**

```sql
select 姓名,课程编号 from 学生信息表,学生选课信息表;


32000000 rows in set (6.88 sec)

结果爆炸。。。
姓名并不会和对应自己选的课组合。而是一一组合。
```
给表起别名
   1. select a.s1,b.s2 from table a,table b;
   2. 可读性好
   3. 执行效率高

#### 防止笛卡尔积现象
```sql
sql92（太老不用）
select a.姓名,b.课程编号 
from 学生信息表 a,学生选课信息表 b
where a.学号 = b.学号
limit 10;

mysql> select a.姓名,b.课程编号
    -> from 学生信息表 a,学生选课信息表 b
    -> where a.学号 = b.学号
    -> limit 10;
+---------+----------+
| 姓名    | 课程编号 |
+---------+----------+
| 包X戎   | D1-1     |
| 琴X阳   | C2-1     |
| 牛X章   | D14-2    |
| 邹X杜   | E6-1     |
| 舒X邢   | C6-2     |
| 和X艾   | C4-2     |
| 华X皮   | A12-1    |
| 隗X弓   | E7-2     |
| 钱X熊   | A19-1    |
| 东郭X饶 | C9-1     |
+---------+----------+
10 rows in set (0.00 sec)
```
1. sql99语句不用where，还可以再用where过滤
2. inner可以省略，加上可读性更好
```sql
sql99(新的)
select a.姓名,b.课程编号 
from 学生信息表 a 
inner join 学生选课信息表 b
on a.学号 = b.学号
limit 10;

mysql> select a.姓名,b.课程编号
    -> from 学生信息表 a
    -> inner join 学生选课信息表 b
    -> on a.学号 = b.学号
    -> limit 10;

+---------+----------+
| 姓名    | 课程编号 |
+---------+----------+
| 包X戎   | D1-1     |
| 琴X阳   | C2-1     |
| 牛X章   | D14-2    |
| 邹X杜   | E6-1     |
| 舒X邢   | C6-2     |
| 和X艾   | C4-2     |
| 华X皮   | A12-1    |
| 隗X弓   | E7-2     |
| 钱X熊   | A19-1    |
| 东郭X饶 | C9-1     |
+---------+----------+
10 rows in set (0.00 sec)
```
#### 自连接
把一张表看成两张表
同一张表中的事物之间有关系，比如上级,情侣
表中没有字段，所以无法演示。
```sql
select a.姓名,b.姓名 
from 表1 a
inner join 表2 b
on a.BOSS = b.姓名
limit 10;
```

#### 外连接
1. 内连接：只要表中有，就会全查出来。
2. 外连接：有一个主表，只要主表中有就会查出来，副表中显示null。
    1. 左连接：左边的是主表
    2. 右外连接：右边的是主表

学生的所有课的成绩，没参加的也要出现
```sql
select a.姓名,b.课程编号,b.成绩
from 学生信息表 a
left join 学生选课信息表 b
on a.学号 = b.学号
order by a.姓名
limit 10;

+---------+----------+------+
| 姓名    | 课程编号 | 成绩 |
+---------+----------+------+
| 丁X乌   | NULL     | NULL |
| 丁X公羊 | NULL     | NULL |
| 丁X寇   | NULL     | NULL |
| 丁X敖   | NULL     | NULL |
| 丁X淳于 | NULL     | NULL |
| 丁X童   | NULL     | NULL |
| 丁X符   | NULL     | NULL |
| 丁X荆   | NULL     | NULL |
| 万X卫   | NULL     | NULL |
| 万X司寇 | NULL     | NULL |
+---------+----------+------+
10 rows in set (2.29 sec)
```

#### 查看每个学生选了多少门课

```sql
select a.姓名,count(b.课程编号)
from 学生信息表 a
join 学生选课信息表 b
on a.学号 = b.学号
group by a.姓名
limit 10;

+---------+-------------------+
| 姓名    | count(b.课程编号) |
+---------+-------------------+
| 包X戎   |                20 |
| 琴X阳   |                19 |
| 牛X章   |                16 |
| 邹X杜   |                19 |
| 舒X邢   |                19 |
| 和X艾   |                17 |
| 华X皮   |                18 |
| 隗X弓   |                21 |
| 钱X熊   |                18 |
| 东郭X饶 |                19 |
+---------+-------------------+

```
#### 最少选了9门课
```sql
select a.姓名,count(b.课程编号)
from 学生信息表 a
join 学生选课信息表 b
on a.学号 = b.学号
group by a.姓名
order by count(b.课程编号) asc
limit 10;

+---------+-------------------+
| 姓名    | count(b.课程编号) |
+---------+-------------------+
| 湛X公西 |                 9 |
| 谈X段干 |                10 |
| 毕X侯   |                11 |
| 蒲X温   |                11 |
| 荆X任   |                12 |
| 宗X邓   |                12 |
| 司X荣   |                12 |
| 闫X娄   |                12 |
| 亓官X利 |                12 |
| 储X杭   |                12 |
+---------+-------------------+
10 rows in set (0.01 sec)
```
#### 查看某一门课选课人数
```sql
select a.课程编号,count(b.姓名)
from 学生选课信息表 a
left join 学生信息表 b
on a.学号 = b.学号
group by a.课程编号
limit 10;

mysql> select a.课程编号,count(b.姓名)
    -> from 学生选课信息表 a
    -> left join 学生信息表 b
    -> on a.学号 = b.学号
    -> group by a.课程编号
    -> limit 10;
+----------+---------------+
| 课程编号 | count(b.姓名) |
+----------+---------------+
| D1-1     |            41 |
| C2-1     |            44 |
| D14-2    |            43 |
| E6-1     |            40 |
| C6-2     |            43 |
| C4-2     |            38 |
| A12-1    |            40 |
| E7-2     |            50 |
| A19-1    |            43 |
| C9-1     |            38 |
+----------+---------------+
10 rows in set (0.01 sec)
```

#### 三张表连接
学生，选课，选课学分

```sql
select a.姓名,b.课程编号,b.成绩,c.学分
from 学生信息表 a
join 学生选课信息表 b
join 课程名称 c
on a.学号 = b.学号 and b.课程编号 = c.课程编号
order by a.姓名
limit 10;

mysql> select a.姓名,b.课程编号,b.成绩,c.学分
    -> from 学生信息表 a
    -> join 学生选课信息表 b
    -> join 课程名称 c
    -> on a.学号 = b.学号 and b.课程编号 = c.课程编号
    -> order by a.姓名
    -> limit 10;
+---------+----------+------+------+
| 姓名    | 课程编号 | 成绩 | 学分 |
+---------+----------+------+------+
| 上官X仉 | C6-1     |   62 |    5 |
| 上官X仉 | C12-1    |   87 |    2 |
| 上官X仉 | C19-2    |   85 |    4 |
| 上官X仉 | E10-2    |   78 |    3 |
| 上官X仉 | C5-1     |   88 |    2 |
| 上官X仉 | D16-2    |   91 |    1 |
| 上官X仉 | E16-2    |   99 |    4 |
| 上官X仉 | D10-2    |   75 |    3 |
| 上官X仉 | B17-2    |   61 |    4 |
| 上官X仉 | D2-1     |   63 |    3 |
+---------+----------+------+------+
10 rows in set (0.02 sec)

```

#### 嵌套子句 每个人的平均分
子查询
每个人的平均分 sum【成绩*学分】/sum【学分】
```sql
select ...(select)...
from ...(select)...
where ...(select)...

```
```sql
select s.姓名,sum(s.成绩*s.学分)/sum(s.学分) 均分
from (
    select a.姓名,b.课程编号,b.成绩,c.学分
    from 学生信息表 a
    join 学生选课信息表 b
    join 课程名称 c
    on a.学号 = b.学号 and b.课程编号 = c.课程编号
    order by a.姓名
    ) s
group by s.姓名
order by 均分 desc
limit 10;

+-------+-------------------+
| 姓名  | 均分              |
+-------+-------------------+
| 郭X农 | 85.31746031746032 |
| 廉X樊 | 83.92592592592592 |
| 储X养 |            83.025 |
| 丰X靳 | 82.91111111111111 |
| 嵇X全 | 82.80555555555556 |
| 皮X扈 | 82.43333333333334 |
| 潘X阴 | 82.34482758620689 |
| 鲁X冷 | 82.21052631578948 |
| 汲X路 | 82.17567567567568 |
| 乐X陆 |  81.9342105263158 |
+-------+-------------------+
10 rows in set (0.02 sec)
```

#### union,将结果集相加
主意最后的limit只能留一个
```sql
select a.姓名, b.课程编号,b.成绩,c.学分
from 学生信息表 a
join 学生选课信息表 b
join 课程名称 c
on a.学号 = b.学号 and b.课程编号 = c.课程编号
where a.姓名 = '丰X靳'
union
select a.姓名, b.课程编号,b.成绩,c.学分
from 学生信息表 a
join 学生选课信息表 b
join 课程名称 c
on a.学号 = b.学号 and b.课程编号 = c.课程编号
where a.姓名 = '皮X扈'
limit 15,10;

+-------+----------+------+------+
| 姓名  | 课程编号 | 成绩 | 学分 |
+-------+----------+------+------+
| 丰X靳 | E14-1    |   81 |    1 |
| 丰X靳 | C16-2    |   84 |    5 |
| 丰X靳 | D14-2    |   95 |    2 |
| 丰X靳 | E4-2     |   82 |    2 |
| 皮X扈 | B1-1     |   63 |    3 |
| 皮X扈 | E6-2     |   88 |    4 |
| 皮X扈 | C5-2     |   66 |    2 |
| 皮X扈 | D8-1     |   98 |    5 |
| 皮X扈 | E9-1     |   65 |    4 |
| 皮X扈 | D5-1     |   70 |    3 |
+-------+----------+------+------+
10 rows in set (0.02 sec)
```